---
title: "Introduction to caRecall"
authors: Nathan Smith, Mitch Harris, Ryan Koenig
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{vrd_vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
library(caRecall)
```

## Pulling Data from the API

This package is an API wrapper for the Government of Canada Vehicle Recalls Database. The Vehicles Recall Database is used by the Defect Investigations and Recalls Division to record and publish recalls of vehicles, tires, and child car seats. The API provides information on the manufacturer, make, model, year manufactured, recall date, number of recalls, as well as information on why the recall happened.

It includes eight functions as listed below.  First you must install the package `caRecall` and then load it into your R document by entering: 
```{r, eval=FALSE}
library(caRecall)
```


## Functions

#### recall_by_make()

Used to retrieve a data frame listing recalls of provided make or manufacturer. It has **seven** inputs which are described as

- make: A string of the make (or manufacturer) of the item you would like to find recall information on. Case insensitive. Can be a list of makes (or manufacturers).
- manufacturer: A boolean, where FALSE is default and TRUE means that you are searching by manufacturer not make.
- start_year: An integer that specifies the year, which the item was manufactured, that you want to start searching. Note that vehicles year is always a year later than when they were manufactured. If left empty defaults to 1900.
- end_year: An integer that specifies the year, which the item was manufactured, that you want to end your search on. Note that vehicles year is always a year later than when they were manufactured. If left empty defaults to 2100.
- limit: An integer that specifies how recalls you want to return. If left empty defaults to 25.
- partial: A boolean, where FALSE is default and TRUE means that you receive back any partial matches (ie. "Su" would return "Suzuki", and "Subaru" matches).
- api_key: A string of the api key needed to access the database. If left empty will error and not provide requested data frame.


If you wanted to search for the first five car recalls by the Ford make in the year 1998, you could search the following.
```{r recall_by_make}
caRecall::recall_by_make("Ford", start_year = 1998, limit = 5)
```

#### recall_by_model()

This function is very similar to the `recall_by_make()` function the only difference being that it searches by model(s) instead of make(s). 

#### recall_by_number()

Once again very similar to the previous two functions but will search by specific recall number. Not as versatile as most would not have the 7-digit recall number on hand but still available for those that do.

#### recall_by_years()

If you only wanted to search by manufacturer year then this function would best suite you.  It pulls all the recalls for any make or model and compiles it to a data frame. Lets say you wanted to search for the first 10 items with a manufacturing date between 1998 and 2001 you could use the following.
```{r recall_by_years}
caRecall::recall_by_years(start_year = 1998, end_year = 2001, limit = 10)
```

#### recall_details()

This function provides the most information on the actual recall as it state the reason for the recall.  If you have found the recall number using any of the previous functions then you can enter it (or multiples) into this function to retrieve more information about it. Lets say we use the recall number from the previous example that affected the Ford Windstar with recall number 1997118.
```{r recall_details}
caRecall::recall_details(1997118)
```
You can see we get several extra columns such as how many units this recall affected, what safety system it impacted, and a detailed comment explaining the recall.


### Count Functions

The next three functions are used to quickly tally up the amount of results you would get back using `recall_by_make()`, `recall_by_model()`, or `recall_by_years()`. 

#### count_recall_by_make(), count_recall_by_model(), count_recall_by_years()
These functions all have the same input parameters as their counter parts, but only return the amount of recalls obtained in the query.  Mostly useful for quick tallying. If we were to specifically look for the amount of recalls that the manufacturer Goodbaby for all of its products manufactured up to 1998 we could use the following.
```{r count_recall_by_make}
caRecall::count_recall_by_make("GOODBABY", manufacturer = TRUE, end_year = 1998)
```

### Example of How to Use the Package

#### Setting up API key

You can enter your API key for this API in manually for each query or you can automate it.First we want to check if your database has the appropriate API key in it's environment by using: 
```{r, eval = FALSE}
caRecall::get_vrd_key()
```
This should return a string with your key.  If it does not you will need to either set your API key to the environment by the function:
```{r, eval = FALSE}
Sys.setenv(VRD_API = "YOUR KEY HERE")
```
Once it is set up you should be able to leave the `api_key` parameter empty in each query.

#### Plotting

Lets say we want to look in the data base for the companies that did the most recalls with the items they manufactured in the year 2000.  First we would start with querying the API for all items recalled that were manufactured in the year 2000.
```{r recall, eval = TRUE}
recall_2000 <- caRecall::recall_by_years(start_year = 2000, end_year = 2000, limit = 10000)
```
We are putting the limit sufficiently high to assume there weren't more than 10,000 recalls that year in Canada. We can count up the data for each company by grouping by the `Manufacturer name` column and counting it. Let's look at only counts about 65 to slim down our variables.
```{r data, eval = TRUE, warning = FALSE, message=FALSE}
library(dplyr)

counts_df <- count(group_by(recall_2000, `Manufacturer Name`))
counts_df <-counts_df[counts_df$n>=64,]
```
This reduces us to 7 companies. We could then plot this using `ggplot2` in a bar plot as seen below.
```{r plot, fig.width=7, fig.height=5, fig.align='center', warning=FALSE, message=FALSE}
library(ggplot2)

plot <- ggplot(counts_df) + 
  aes(
    x=`Manufacturer Name`,
    y=n,
    fill=`Manufacturer Name`) +
  geom_col() +
  geom_text(
    aes(label=n),
    vjust=-.5
  ) +
  labs(y="Total Recalls") +
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        axis.line = element_line(color = "black"),
        ) +
  scale_y_continuous(expand = c(0,0),
                     limits = c(0,250)) +
  ggtitle("Top Companies by Recall Count in 2000")
  
plot
```


We could also look at how many recalls vehicles of the make Ford has done compared to Nissan for vehicles manufactured over the last 10 years.
We would start by querying a list with both "Ford" and "Nissan" in it.  We would want the start year to be 2011 and once again we would want to set the limit high enough to contain all our queries. We would need to set partial to be true in this case otherwise it will try to find makes that contain "Ford" and "Nissan".
```{r}
recall_2010 <- caRecall::recall_by_make(c("Ford","Nissan"), start_year = 2011, limit = 10000, partial = TRUE)
```

We can then plot the total amount of recalls for each manufacturers year and add a trend line to it. I would recommend reading up on the the ggplot2 package for more details on how to create these plots.

```{r plot2, fig.width=7, fig.height=5, fig.align='center', warnings = FALSE, message = FALSE}
plot2 <- recall_2010 %>%
  ggplot() +
  aes(x=`Year`,
      color = `Make name`) + 
  geom_point(stat='count', size=6 ) 

dat <- layer_data(plot2)
plot2 + stat_smooth(data = dat,
                    aes(x,
                        y,
                        colour=colour),
                    method="lm",
                    se=FALSE) + 
  scale_size(guide="none") + 
  scale_color_manual(
    values = c("#00BFC4","#F8766D","#F8766D","#00BFC4"),
    breaks=c("FORD", "NISSAN")) +
      labs(y="Recalls per Year") +
  scale_x_continuous(breaks = seq(2010,2021,1)) +
  ggtitle("Amount of Recalls per Year")
```


### Documentation for the wrapped API can be found at:

https://tc.api.canada.ca/en/detail?api=VRDB


